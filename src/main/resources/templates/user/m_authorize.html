<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">
    <title>授权登录</title>
    <link rel="stylesheet" th:href="@{/css/m_authorize.css}">
</head>
<body>
<!--这里需要重新弄下-->
<div class="container">
    <header class="icon">
        <img style="width: 60%;" th:src="@{/images/pc.png}">
    </header>
    <section>
        <article class="message">
            <p th:inline="text">您的账号正试图在一台电脑([[${ipAddr}]])登录，请选择是否允许。</p>
        </article>
        <article style="margin-top: 100px" class="ctrl">
            <button style="background-color: #4BC065;width: 50%;margin: 10px auto" data-agree="true">允许登录</button>
            <button style="background-color: #FFFFFF;color: #7F7F7F;font-size: 15px" data-agree="false">取消登录</button>
        </article>
    </section>
</div>
</body>
<script type="text/javascript" th:src="@{/js/errorCode.js}"></script>
<script th:inline="javascript">
    (function (win, doc) {
        const xhr = new XMLHttpRequest();
        doc.querySelectorAll('.ctrl button').forEach(button => {
            button.addEventListener('click', function () {
                    //手机端扫码发送的请求
                    xhr.open('post', "/user/qrlogin/authorize", true);
                    xhr.responseType = "json";
                    xhr.setRequestHeader('content-type', 'application/x-www-form-urlencoded');
                    // alert("手机端准备发送请求");
                    xhr.onload = function () {
                        // alert("手机端发送请求完毕");
                        if (this.status === 200 || this.status === 302) {
                            alert(111)
                            const response = this.response;
                            alert(response.success)
                            if (response.success) {

                                // alert("手机端跳去的页面")
                                // 手机端跳去的页面
                                // win.location.href = `/user/home`;
                                finish();
                            } else {
                                alert(ERR[response.code]);
                            }
                        }
                    }
                    xhr.send(`agree=${this.dataset.agree}`);
                }
            );
        });
    })(window, document);
    var finish = function () {
        var browser = navigator.userAgent.toLowerCase();
        //微信扫码登录
        if (browser.match(/MicroMessenger/i) == "micromessenger") {
            // alert("微信客户端");
            alert("操作完成,页面即将关闭");
            WeixinJSBridge.call('closeWindow');
        } else {
            alert("操作完成,请关闭页面")
            window.location.href = "about:blank"
            window.close();
        }
    }
</script>
</html>
